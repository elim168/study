# 通过Filter传参

通过Filter可以实现在客户端和服务端之间传递参数，通常用来传递一些通用的参数，比如最源端的客户端IP地址，用来进行调用链追踪的请求ID等。在客户端可以通过Invocation的setAttachment设置需要传递的参数，然后可以在服务端通过getAttachment获取相应的参数。比如下面定义的ParamSendFilter是作用在客户端的，其往调用链中传递了两个参数。

```java
@Activate(group = "consumer")
public class ParamSendFilter implements Filter {

  @Override
  public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
    invocation.setAttachment("sendTime", LocalDateTime.now().toString());
    Map<String, String> attachments = invocation.getAttachments();
    attachments.put("foo", "bar");
    return invoker.invoke(invocation);
  }

}
```

下面定义的ParamReceiveFilter通过Invocation获取了客户端传递过来的通用参数。

```java
@Activate(group = "provider")
public class ParamReceiveFilter implements Filter {

  @Override
  public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
    String fooValue = invocation.getAttachment("foo");
    String foo1Value = invocation.getAttachment("foo1", "defaultValue");
    Map<String, String> attachments = invocation.getAttachments();
    String sendTime = attachments.get("sendTime");
    System.out.println(fooValue);
    System.out.println(foo1Value);
    System.out.println(sendTime);
    System.out.println(attachments);
    return invoker.invoke(invocation);
  }

}
```

上面定义的传递的参数是直接写死的，在实际应用中它们通常会通过一个ThreadLocal变量获取，然后在服务端的Filter中获取到了后也会存储到一个线程变量中，方便后续的获取。Dubbo其实已经内置了这样一个ThreadLocal对象，它就是RpcContext，可以通过`RpcContext.getContext()`获取当前线程绑定的RpcContext，通过RpcContext对象的setAttachment/getAttachement方法可以设置和获取参数。客户端通过RpcContext的setAttachment设置的参数会传递到服务端，可以在服务端的Filter中通过Invocation的getAttachment获取，也可以在服务端通过RpcContext获取。下面代码中在调用远程服务前通过RpcContext设置了参数ABC，该参数会传递到服务端。

```java
@Test
public void testConsumer() throws Exception {
    ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext("/hello-client.xml");
    HelloService helloService = applicationContext.getBean(HelloService.class);
    RpcContext.getContext().setAttachment("ABC", "123");
    helloService.sayHello("Elim");
}
```

下面代码中，在服务端的服务实现方法中通过RpcContext的getAttachment方法获取了客户端传递的参数ABC。

```java
public class HelloServiceImpl implements HelloService {

    @Override
    public void sayHello(String name) {
        System.out.println("Hello " + name);
        System.out.println("Invoke completed" + RpcContext.getContext().getAttachment("ABC"));
    }
}
```

（注：本文是基于Dubbo2.7.2所写）