# 简介

Kafka是Apache基金会的一个分布式流平台，也是一个消息队列。官网是[http://kafka.apache.org/](http://kafka.apache.org/)。

## Topic

Kafka的消息通过Topic来进行分类，一条消息只能属于一个Topic。Topic又会分区，一个Topic可以定义1-N个分区，一条消息只会发送到Topic的某一个分区中。每个分区中的消息是有顺序的，同一个生产者发送两条消息到同一个Topic的同一个分区中，M1和M2，那么它们存储在分区中的顺序也是M1、M2，消费的时候也是按照M1、M2的顺序进行消费。

![Topic](image/log_anatomy.png)

## Cluster

Kafka的服务器是可以有多台的，多台服务器可以组成一个集群。服务器与服务器之间是主从关系，只有主服务器才能提供读写服务。这种主从关系不是针对整个Topic而言的，而是针对的Topic的某个分区。比如一个Topic有4个分区，Cluster中有四台机器。那么这四台机器会分别是4个分区的主服务器，剩下的三台是从服务器。这样就达到了一个负载均衡的效果，将读写请求都分配到了四台机器。它们之间的关系可以用下表来表示。

| 分区 | 主机器 | 从机器 |
| :---: | :-----: | :-----: |
| P1 | S1 | S2/S3/S4 |
| P2 | S2 | S1/S3/S4 |
| P3 | S3 | S1/S2/S4 |
| P4 | S4 | S1/S2/S3 |

主节点负责处理读写请求，而从节点会从主节点复制消息，作为主节点的副本。当主节点挂了后，会重新选举一个从节点作为主节点。比如上面的S1挂了后，分区P1的主节点可能就变成S2了，从节点就是S3/S4。所以对于一个有N台机器的Cluster来说，最多允许有N-1台机器宕机。

## Producer

Producer用来发送消息。它在发送消息时也可以选择消息需要发送到哪个Topic的哪个分区。

## Consumer

Consumer用来消费消息，它需要订阅需要消费的消息所属的Topic。Consumer需要指定一个group，一个group下可以有多个Consumer实例，这些实例可以是在一个进程中，也可以是在多个进程中。同一个group的Consumer共享Topic分区中的消息，每一条消息都只能由一个Consumer实例消费。Topic的每一个分区也只能由某一个Consumer实例消费，所以如果Consumer实例多于分区数时，有些Consumer会得不到可消费的分区，也就没有可消费的消息。属于不同group的Consumer之间没有什么关联，当两个Consumer属于不同的group时，它们都可以消费所订阅的Topic的消息，彼此独立。关于Consumer、group和Topic分区的关系可以用下面这张图来表示。

![consumer-group](image/consumer-groups.png)

在上面这张图中我们的Topic有四个分区，Kafka集群中有两个节点，节点1负责分区1和4的读写请求，节点2负责分区2和3的读写请求。有两个Consumer group，group A有两个实例，group B有四个实例，group A的两个实例平均分配了四个分区，各得两个，group B与group A是相互独立的，所以它也需要消费上面的四个分区，它有四个实例，平均每个分配到了一个分区。

消息在分区中不会因为消息被Consumer消费了就删除了，它会一直存在于分区中，直到达到了它的过期时间，可以进行配置，比如一天或者两天，默认的配置文件中定义的是7天。当达到了过期时间后对应的消息才会被删除，以此来释放所占用的资源。这样做的好处是消息可以被不同的Consumer进行消费，也可以由同一个Consumer消费多次。Consumer在从分区中消费消息时需要指定从哪里开始消费，这个消费位置是由Consumer进行维护的，所以每个Consumer的消费位置是独立的。下图就描述了它们之间的这种关系。

![Consumer](image/log_consumer.png)


（注：本文是基于Kafka2.3.0所写）