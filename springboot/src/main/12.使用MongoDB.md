# 使用MongoDB

需要在Spring Boot应用中使用MongoDB，可以在pom.xml中添加`spring-boot-starter-data-mongodb`依赖，这样Spring Boot会自动配置MongoDB的相关bean，比如MongoClient、MongoTemplate等，可以参考Spring Data MongoDB的自动配置类`org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration`的API文档或源码。

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

默认配置的MongoDB连接对应的主机是localhost，端口号是标准端口号27017，database是test。可以通过`spring.data.mongodb`打头的配置属性进行配置，对应的属性将绑定到`org.springframework.boot.autoconfigure.mongo.MongoProperties`对象，下面的代码重新配置了主机、端口号和database。更多配置信息可以参考`MongoProperties`的API文档或源代码。

```properties
spring.data.mongodb.host=10.192.48.170
spring.data.mongodb.port=27017
spring.data.mongodb.database=test_db
```

之后就可以直接通过MongoTemplate进行MongoDB的操作了。下面的代码中定义了一个User类，其userId属性对应MongoDB的user这个document的id属性，username属性对应于MongoDB的user这个document的user_name属性。然后在测试类中，new了一个User对象，通过MongoTemplate对象把它存入到了MongoDB中。

```java
@Document
@Data
public class User {

    @Id
    private Long userId;
    private String name;
    @Field("user_name")
    private String username;
    
}

@SpringBootTest(classes=Application.class)
@RunWith(SpringJUnit4ClassRunner.class)
public class MongoTest {

    @Autowired
    private MongoTemplate mongoTemplate;
    
    @Test
    public void testSave() {
        User user = new User();
        user.setUserId(2L);
        user.setName("张三");
        user.setUsername("zhangsan");
        this.mongoTemplate.save(user);
    }
    
}
```

也可以定义Spring Data Repository，通过Repository对MongoDB进行访问。定义的Repository，Spring Boot将自动对其进行扫描，由`org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration`定义，扫描路径是Spring Boot启动类所在的包。有需要也可以手动加上`@EnableMongoRepositories`以指定需要扫描的路径。下面的代码定义了一个UserRepository，其继承自标准的MongoRepository，同时又按照Spring Data的规范定义了一个findByName方法。

```java
public interface UserRepository extends MongoRepository<User, Long> {

    List<User> findByName(String name);
    
}
```

之后可以直接在需要的地方注入UserRepository，通过UserRepository访问MongoDB，下面的代码中就分别利用注入的UserRepository进行了User对象的新增和查询操作。

```java
@SpringBootTest(classes=Application.class)
@RunWith(SpringJUnit4ClassRunner.class)
public class MongoTest {

    @Autowired
    private UserRepository userRepository;
    
    @Test
    public void testSave() {
        User user = new User();
        user.setUserId(3L);
        user.setName("张三");
        user.setUsername("zhangsan");
        this.userRepository.save(user);
    }
    
    @Test
    public void testFindByName() {
        List<User> users = this.userRepository.findByName("张三");
        Assert.assertNotNull(users);
        Assert.assertEquals("张三", users.get(0).getName());
    }
    
}
```

> 本文旨在描述在Spring Boot应用中如何使用MongoDB，所以对Spring Data MongoDB的内容没有讲解太多。


（注：本文是基于Spring Boot 2.0.3所写）


