# 使用SpringMVC

使用SpringMVC最简单的方法是在`pom.xml`中加入`spring-boot-starter-web`依赖，这样Spring Boot的AutoConfiguration模块将为我们自动进行SpringMVC的配置，创建好`RequestMappingHandlerAdapter`、`RequestMappingHandlerMapping`等，详情可以参考`org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration`和`DelegatingWebMvcConfiguration`的源码。

这个时候就可以定义如下这样一个控制器，当请求`/hello/json`时将返回`{"key1": "value1", "key2": "value2"}`这样一段JSON。当Classpath下存在jackson相关的Class时就会自动添加`MappingJackson2HttpMessageConverter`这样一个`HttpMessageConverter`。关于默认添加的`HttpMessageConverter`可以参考`WebMvcConfigurationSupport`的`addDefaultHttpMessageConverters()`的源码说明。

```java
@RestController
@RequestMapping("hello")
public class HelloController {

    @GetMapping("json")
    public Object jsonResult() {
        Map<String, Object> map = new HashMap<>();
        map.put("key1", "value1");
        map.put("key2", "value2");
        return map;
    }
    
}
```

## 添加自定义的HttpMessageConverter

添加自定义的`HttpMessageConverter`比较方便的方法是通过`org.springframework.boot.autoconfigure.http.HttpMessageConverters`定义，它可以在指定使用默认的`HttpMessageConverter`的同时添加额外的`HttpMessageConverter`。下面的代码中就指定了在使用默认的`HttpMessageConverter`的同时添加了一个自定义的`CustomHttpMessageConverter`。

@Configuration
public class MvcConfiguration {

    @Bean
    public HttpMessageConverters httpMessageConverters() {
        HttpMessageConverter<?> customHttpMessageConverter = new CustomHttpMessageConverter();
        List<HttpMessageConverter<?>> additional = new ArrayList<>();
        additional.add(customHttpMessageConverter);
        HttpMessageConverters converters = new HttpMessageConverters(true, additional);
        return converters;
    }
    
}

> `HttpMessageConverters`有几个重载的构造方法，使用时可以参考对应的API文档选择合适的进行使用。

Spring Boot中拥有一个`HttpMessageConvertersAutoConfiguration`类，其会在未定义`HttpMessageConverters`类型的bean时，自动注册一个`HttpMessageConverters`类型的bean，即会通过它来使用默认的`HttpMessageConverter`。此外，其会在自动注册bean容器中定义的`HttpMessageConverter`，所以使用默认配置时也可以把需要注册的`HttpMessageConverter`定义为bean容器中的一个bean。`HttpMessageConvertersAutoConfiguration`中拥有一个`StringHttpMessageConverterConfiguration`类，会在bean容器中未定义`StringHttpMessageConverter`类型的bean时自动定义一个，使用的字符集默认是`UTF-8`，可以通过在`application.properties`中通过`spring.http.encoding.charset`指定。

## Converter和Formatter注册

下面的代码来自于`WebMvcAutoConfigurationAdapter`，从代码中可以看出Spring Boot会自动注册bean容器中定义的Converter和Formatter。

```java
@Override
public void addFormatters(FormatterRegistry registry) {
    for (Converter<?, ?> converter : getBeansOfType(Converter.class)) {
        registry.addConverter(converter);
    }
    for (GenericConverter converter : getBeansOfType(GenericConverter.class)) {
        registry.addConverter(converter);
    }
    for (Formatter<?> formatter : getBeansOfType(Formatter.class)) {
        registry.addFormatter(formatter);
    }
}
```

## 静态资源的处理

Spring Boot默认会把Classpath下的`/META-INF/resources/`、`/resources/`、`/static/`和`/public/`映射为静态资源路径。静态资源的相关配置由`ResourceProperties`类定义，对应的配置属性前缀是`spring.resources`。



更多配置信息可以参考`ResourceProperties`的源代码。






（注：本文是基于Spring Boot 2.0.3所写）

